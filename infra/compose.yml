x-env: &defaults
  ENV: prod
  TZ: Asia/Kolkata
  REDIS_URL: redis://redis:6379/0
  FEED_KEY: feed:items
  SEEN_KEY: feed:seen
  SOURCES_FILE: /app/infra/source.yml
  TMDB_API_KEY: ${TMDB_API_KEY:-}

services:
  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --save
      - ""
      - --appendonly
      - "yes"
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: sh -c 'redis-cli ping | grep -q PONG'
      interval: 10s
      timeout: 3s
      retries: 5

  api:
    build:
      context: ..
      dockerfile: infra/Dockerfile
      target: api
    restart: unless-stopped
    env_file: ../.env
    environment:
      <<: *defaults
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:18000:8000"
    command: >
      gunicorn -w 2 -k uvicorn.workers.UvicornWorker
      -b 0.0.0.0:8000 apps.api.app.main:app
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    stop_grace_period: 20s

  workers:
    build:
      context: ..
      dockerfile: infra/Dockerfile
      target: worker
    restart: unless-stopped
    env_file: ../.env
    environment:
      <<: *defaults
      RQ_REDIS_URL: ${REDIS_URL}
    depends_on:
      redis:
        condition: service_healthy
    command: >
      sh -lc 'rq worker -u "${REDIS_URL:-redis://redis:6379/0}" events'
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    stop_grace_period: 10s

  scheduler:
    build:
      context: ..
      dockerfile: infra/Dockerfile
      target: scheduler
    restart: unless-stopped
    env_file: ../.env
    environment:
      <<: *defaults
    depends_on:
      redis:
        condition: service_healthy
    command:
      - python
      - -m
      - apps.scheduler.main
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    stop_grace_period: 10s

  webhooks:
    build:
      context: ..
      dockerfile: infra/Dockerfile
      target: webhooks
    restart: unless-stopped
    env_file: ../.env
    environment:
      <<: *defaults
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:18001:8000"
    command: uvicorn apps.webhooks.main:app --host 0.0.0.0 --port 8000
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    stop_grace_period: 10s

volumes:
  redis-data: {}
